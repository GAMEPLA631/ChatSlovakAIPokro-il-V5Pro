<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatSlovak AI Pokroƒçil√Ω V5 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Kni≈ænice pre pokroƒçil√∫ funkƒçnos≈• a 3D grafiku -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.10/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Tmav√© pozadie pre lep≈°√≠ disco efekt */
            background-color: #1f003e; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            position: relative; 
            overflow: hidden;
        }
        /* ≈†t√Ωly pre 3D Canvas pozadie */
        #bg-canvas {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1; 
            display: block;
        }
        #chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            
            /* SKLENEN√ù EFEKT */
            background-color: rgba(255, 255, 255, 0.1); /* Priesvitn√© pozadie */
            backdrop-filter: blur(15px); /* Kƒæ√∫ƒçov√Ω efekt rozostrenia */
            -webkit-backdrop-filter: blur(15px); /* Pre Safari */
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2); /* Jemn√Ω biely okraj */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Hlb≈°√≠, priehƒæadn√Ω tie≈à */
            overflow: hidden;
            z-index: 10; 
        }
        
        .chat-header {
            /* Sklenen√° hlaviƒçka, tmav√© p√≠smo */
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-footer {
            /* Sklenen√° p√§tiƒçka */
            background-color: rgba(255, 255, 255, 0.05); 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .user-message {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-message {
            /* AI bublina zost√°va takmer biela pre ƒçitateƒænos≈•, s miernou transparentnos≈•ou */
            background-color: rgba(255, 255, 255, 0.85); 
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            white-space: pre-wrap; /* Preserve formatting from markdown response */
        }
        .source-link {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        #loading-indicator {
            padding: 0.5rem;
            text-align: center;
            color: #9ca3af;
        }
        /* Style for markdown-like formatting */
        .ai-message p, .ai-message ul, .ai-message ol, .ai-message strong {
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
    </style>
</head>
<body>

<!-- 3D Canvas pre dynamick√© pozadie -->
<canvas id="bg-canvas"></canvas>

<div id="chat-container">
    <!-- Chat Header -->
    <header class="chat-header p-4 text-white text-center rounded-t-xl shadow-lg">
        <h1 class="text-xl font-bold">üí¨ ChatSlovak AI Pokroƒçil√Ω V5 Pro</h1>
        <p class="text-sm text-gray-400">Na≈°a spoloƒçnos≈• GAMEPLA631: P√Ωtajte sa na veƒæmi zlo≈æit√© t√©my. Pou≈æ√≠va overen√© d√°ta (Grounding).</p>
        <!-- NOV√ù INDIK√ÅTOR STAVU LIMITU -->
        <span id="limit-status" class="text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-indigo-700/50">
            Naƒç√≠tavam limit...
        </span>
    </header>

    <!-- Messages Area -->
    <div id="messages">
        <div class="message-bubble ai-message">
            <p>Vitaj v **ChatSlovak AI Pokroƒçil√Ω V5 Pro!** Som tvoj ≈°pecializovan√Ω **Model V5**. Som tu, aby som ti ako hlavn√Ω analytik spoloƒçnosti GAMEPLA631 pomohol s hƒ∫bkov√Ωm spracovan√≠m d√°t, rie≈°en√≠m zlo≈æit√Ωch strategick√Ωch v√Ωziev a komplexnou anal√Ωzou. Pripraven√Ω na pr√°cu!</p>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden">
        <!-- Zmenen√° textov√° spr√°va pri naƒç√≠tavan√≠ podƒæa po≈æiadavky pou≈æ√≠vateƒæa -->
        <div class="animate-pulse">Rozm√Ω≈°ƒæam Pre lep≈°iu odpoveƒè ƒçakaj 90s</div>
    </div>

    <!-- Input Form -->
    <form id="chat-form" class="p-4 border-t border-gray-200 chat-footer">
        <div class="flex space-x-3">
            <input type="text" id="user-input" placeholder="Zadajte svoju zlo≈æit√© po≈æiadavku..." required class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <button type="submit" id="send-button" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center disabled:bg-blue-400">
                Odosla≈•
            </button>
        </div>
    </form>
</div>

<script>
    // --- 3D Background Initialization (Three.js) ---
    let scene, camera, renderer, discoBall;
    let discoLights = [];
    const lightColors = [0xff00ff, 0x00ffff, 0xffff00]; // Farby pre disco l√∫ƒçe: Magenta, Cyan, Yellow
    const canvas = document.getElementById('bg-canvas');
    let mouseX = 0, mouseY = 0;

    function init3D() {
        // Sc√©na
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111); // Veƒæmi tmav√© pozadie

        // Kamera
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 3000); 
        camera.position.z = 200;

        // Renderer
        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true }); 
        renderer.setSize(window.innerWidth, window.innerHeight);

        // Ambient Light
        // Mierne ambientn√© svetlo, aby boli viditeƒæn√© tmav√© strany gule
        const ambientLight = new THREE.AmbientLight(0x404040, 0.5); 
        scene.add(ambientLight);

        // 1. Disco Guƒæa (Sphere)
        const ballGeometry = new THREE.SphereGeometry(40, 64, 32);
        // MeshPhongMaterial pre leskl√Ω, reflexn√Ω vzhƒæad
        const ballMaterial = new THREE.MeshPhongMaterial({
            color: 0xcccccc,
            specular: 0xffffff, // Biela spektr√°lna farba
            shininess: 100, // Vysok√Ω lesk
            reflectivity: 0.9,
        });
        discoBall = new THREE.Mesh(ballGeometry, ballMaterial);
        scene.add(discoBall);

        // 2. Disco Svetl√° (Point Lights orbiting the ball)
        const lightIntensity = 2;
        const lightDistance = 200;
        const lightOrbitRadius = 150;

        lightColors.forEach((colorHex, index) => {
            // PointLight simuluje siln√Ω bodov√Ω l√∫ƒç, ktor√Ω dopad√° na guƒæu
            const pointLight = new THREE.PointLight(colorHex, lightIntensity, lightDistance);
            pointLight.position.x = lightOrbitRadius * Math.cos(index * Math.PI * 2 / 3);
            pointLight.position.y = lightOrbitRadius * Math.sin(index * Math.PI * 2 / 3);
            pointLight.position.z = 0;
            scene.add(pointLight);
            discoLights.push(pointLight);
        });
        
        // Event listener pre sledovanie my≈°i (pre interaktivitu)
        document.addEventListener('mousemove', onDocumentMouseMove, false);
        window.addEventListener('resize', onWindowResize, false);
    }

    function onDocumentMouseMove(event) {
        // Upravuje poz√≠ciu kamery (virtu√°lny pohyb)
        mouseX = (event.clientX - window.innerWidth / 2) * 0.2;
        mouseY = (event.clientY - window.innerHeight / 2) * 0.2;
    }

    function onWindowResize() {
        // Zabezpeƒçuje responz√≠vnos≈• 3D pl√°tna
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate3D() {
        requestAnimationFrame(animate3D);

        const time = Date.now() * 0.0002;
        
        // 1. Rot√°cia Disco Guƒæa
        discoBall.rotation.y += 0.005; 
        discoBall.rotation.x += 0.002;

        // 2. Pohyb svetiel (orbit√°lny pohyb okolo stredu)
        const orbitRadius = 150;
        discoLights.forEach((light, index) => {
            const angle = time * (index + 1) * 0.5;
            // Orbit√°lny pohyb XZ
            light.position.x = orbitRadius * Math.cos(angle + index * 1.5);
            light.position.z = orbitRadius * Math.sin(angle + index * 1.5);
            // Vertik√°lny pohyb Y
            light.position.y = 50 * Math.sin(time + index); 
        });

        // Pomaly pos√∫vame kameru v reakcii na my≈°
        camera.position.x += (mouseX - camera.position.x) * 0.05;
        camera.position.y += (-mouseY - camera.position.y) * 0.05;
        camera.lookAt(scene.position);
        
        renderer.render(scene, camera);
    }

    // --- Rate Limiting Configuration ---
    const MAX_MESSAGES_PER_HOUR = 38;
    const LIMIT_WINDOW_MS = 60 * 60 * 1000; // 1 hodina v milisekund√°ch
    const STORAGE_KEY_COUNT = 'chatLimitCount';
    const STORAGE_KEY_RESET = 'chatLimitReset';

    /** Pomocn√° funkcia na z√≠skanie d√°t limitu z localStorage */
    function getLimitData() {
        const count = parseInt(localStorage.getItem(STORAGE_KEY_COUNT) || '0', 10);
        // Reset time je ulo≈æen√Ω ako timestamp (milisekundy od epochy)
        const resetTime = parseInt(localStorage.getItem(STORAGE_KEY_RESET) || '0', 10);
        return { count, resetTime };
    }

    /** Pomocn√° funkcia na ulo≈æenie d√°t limitu do localStorage */
    function updateLimitData(count, resetTime) {
        localStorage.setItem(STORAGE_KEY_COUNT, count.toString());
        localStorage.setItem(STORAGE_KEY_RESET, resetTime.toString());
    }
    
    /** Aktualizuje UI element s inform√°ciou o zost√°vaj√∫com limite */
    function updateLimitStatusDisplay() {
        const { count, resetTime } = getLimitData();
        const now = Date.now();
        const limitStatusElement = document.getElementById('limit-status');
        
        if (now >= resetTime) {
            // Limit vypr≈°al alebo je to prv√° spr√°va
            limitStatusElement.textContent = `Spr√°vy: ${count} / ${MAX_MESSAGES_PER_HOUR} (LIMIT OK)`;
            limitStatusElement.className = "text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-green-600/70";
        } else if (count >= MAX_MESSAGES_PER_HOUR) {
            // Limit je prekroƒçen√Ω
            const timeLeftMs = resetTime - now;
            const minutesLeft = Math.ceil(timeLeftMs / (60 * 1000));
            limitStatusElement.textContent = `BLOKOVAN√â: Reset o ${minutesLeft} min.`;
            limitStatusElement.className = "text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-red-700/70";
        } else {
            // Poƒç√≠tadlo be≈æ√≠
            const timeLeftMs = resetTime - now;
            const minutesLeft = Math.ceil(timeLeftMs / (60 * 1000));
            limitStatusElement.textContent = `Spr√°vy: ${count} / ${MAX_MESSAGES_PER_HOUR} (Reset za ${minutesLeft} min)`;
            limitStatusElement.className = "text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-yellow-600/70";
        }
    }


    /**
     * Kontroluje a aplikuje limit poƒçtu spr√°v (38/hodinu).
     * @returns {boolean} True, ak je povolen√© odosla≈• spr√°vu, inak False.
     */
    function checkAndApplyRateLimit() {
        let { count, resetTime } = getLimitData();
        const now = Date.now();

        // 1. Skontrolujeme, ƒçi vypr≈°alo ƒçasov√© okno
        if (now >= resetTime) {
            // Okno vypr≈°alo, resetujeme poƒç√≠tadlo a nastav√≠me nov√© okno (1 hodina od teraz)
            count = 0;
            resetTime = now + LIMIT_WINDOW_MS;
            // V tomto kroku e≈°te neuklad√°me, poƒçk√°me, k√Ωm sa zist√≠, ƒçi spr√°va prejde
        }

        // 2. Skontrolujeme, ƒçi bol limit prekroƒçen√Ω (blokujeme 39. spr√°vu)
        if (count >= MAX_MESSAGES_PER_HOUR) {
            // Limit je prekroƒçen√Ω
            const timeLeftMs = resetTime - now;
            const minutesLeft = Math.ceil(timeLeftMs / (60 * 1000));
            
            // Zobrazenie chybovej spr√°vy v chate (Custom UI, nie alert)
            const resetTimeFormatted = new Date(resetTime).toLocaleTimeString('sk-SK', { hour: '2-digit', minute: '2-digit' });
            const errorMessage = `**LIMIT PREKROƒåEN√ù.** Bol dosiahnut√Ω limit ${MAX_MESSAGES_PER_HOUR} spr√°v za hodinu. Sk√∫ste to znova za pribli≈æne **${minutesLeft} min√∫t** (reset o ${resetTimeFormatted}).`;
            displayMessage(errorMessage, 'ai');
            
            updateLimitStatusDisplay(); // Aktualizujeme zobrazenie, ≈æe je zablokovan√©
            return false; // Blokova≈• odoslanie spr√°vy
        }

        // 3. Limit nie je prekroƒçen√Ω, zv√Ω≈°ime poƒç√≠tadlo a ulo≈æ√≠me stav
        count++;
        
        // Ak je to prv√° spr√°va, mus√≠me zabezpeƒçi≈•, ≈æe resetTime je nastaven√Ω
        if (count === 1) { 
            if (resetTime === 0 || now >= resetTime) {
                resetTime = now + LIMIT_WINDOW_MS;
            }
        }

        updateLimitData(count, resetTime); // Ulo≈æ√≠me nov√Ω stav po √∫spe≈°nej kontrole
        updateLimitStatusDisplay(); // Aktualizujeme zobrazenie, ≈æe poƒçet spr√°v sa zv√Ω≈°il
        return true; // Povoli≈• odoslanie spr√°vy
    }

    // --- API Configuration and Global Variables ---

    // D√îLE≈ΩIT√â: Vlo≈æte svoj Gemini API kƒæ√∫ƒç sem.
    const apiKey = "AIzaSyAzWkdCBiqlrFZODs2zEichlIWe68Wo2eI"; // Nechajte pr√°zdne, ak ho poskytuje prostredie Canvas.
    const apiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/";
    
    // Pou≈æ√≠vame ≈°piƒçkov√Ω model na veƒæmi zlo≈æit√© veci, ktor√Ω je pre u≈æ√≠vateƒæa oznaƒçen√Ω ako "V5"
    const modelName = 'gemini-2.5-pro';
    const apiUrl = `${apiUrlBase}${modelName}:generateContent?key=${apiKey}`;

    // Syst√©mov√© in≈°trukcie pre pokroƒçil√∫ AI (definuj√∫ jej osobnos≈• a ≈°t√Ωl)
    const systemInstruction = {
        parts: [{ 
            text: "Si ≈°piƒçkov√Ω analytik, strat√©g a vedeck√Ω konzultant. Tvojou √∫lohou je spracov√°va≈• mimoriadne zlo≈æit√©, multi-disciplin√°rne ot√°zky. Tvoje odpovede musia by≈• hƒ∫bkov√©, syntetick√©, logicky ≈°trukt√∫rovan√© (napr. s pou≈æit√≠m oƒç√≠slovan√Ωch bodov, odsekov alebo zoznamov) a musia preukazova≈• pokroƒçil√© kritick√© myslenie. V≈ædy pou≈æi Google Search na overenie a poskytnutie aktu√°lnych, faktick√Ωch inform√°ci√≠ pre komplexn√© t√©my, ak si to ot√°zka vy≈æaduje. Odpovedaj v√Ωhradne v slovenƒçine." 
        }]
    };

    let chatHistory = [];
    const messagesDiv = document.getElementById('messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const loadingIndicator = document.getElementById('loading-indicator');

    // --- UI Functions ---

    /** Vytvor√≠ a prid√° bublinu spr√°vy do chatu */
    function displayMessage(text, sender, sources = []) {
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${sender === 'user' ? 'user-message' : 'ai-message'}`;
        
        // Konvertujeme Markdown na HTML pre lep≈°iu ƒçitateƒænos≈• AI odpoved√≠
        const formattedText = marked.parse(text); 
        bubble.innerHTML = formattedText;

        // Pridanie zdrojov (grounding) pre AI odpovede
        if (sender === 'ai' && sources.length > 0) {
            const sourcesList = document.createElement('div');
            sourcesList.className = "mt-2 pt-2 border-t border-gray-300 text-xs";
            sourcesList.innerHTML = `<strong class="text-gray-600">Zdroje:</strong>`;
            
            // Limitujeme na 3 zdroje pre prehƒæadnos≈•
            sources.slice(0, 3).forEach((source, index) => {
                if (source.uri && source.title) {
                    const link = document.createElement('a');
                    link.href = source.uri;
                    link.target = "_blank";
                    link.className = "source-link hover:text-blue-600";
                    link.textContent = `${index + 1}. ${source.title}`;
                    sourcesList.appendChild(link);
                }
            });
            bubble.appendChild(sourcesList);
        }

        messagesDiv.appendChild(bubble);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom
    }

    /** Nastav√≠ stav naƒç√≠tania */
    function setLoading(isLoading) {
        sendButton.disabled = isLoading;
        input.disabled = isLoading;
        loadingIndicator.classList.toggle('hidden', !isLoading);
    }

    // --- Core API Logic ---

    /**
     * Implementuje exponenci√°lne oneskorenie a opakovan√© pokusy pre API volania.
     * @param {number} attempt Aktu√°lny pokus (od 1).
     * @returns {Promise<number>} oneskorenie v milisekund√°ch.
     */
    function delay(attempt) {
        const baseDelay = 1000; // 1 sekunda
        const maxDelay = 16000; // Max 16 sek√∫nd
        const currentDelay = Math.min(maxDelay, baseDelay * Math.pow(2, attempt - 1));
        return new Promise(resolve => setTimeout(resolve, currentDelay));
    }

    /** Spracuje odoslanie formul√°ra a zavol√° Gemini API. */
    async function sendMessage(event) {
        event.preventDefault();
        const userQuery = input.value.trim();
        if (!userQuery) return;

        // KONTROLA LIMITU: Ak je limit prekroƒçen√Ω, ukonƒç√≠me funkciu
        if (!checkAndApplyRateLimit()) {
            input.value = ''; // Vyƒçist√≠me vstup po ne√∫spe≈°nom pokuse
            return;
        }

        displayMessage(userQuery, 'user');
        chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
        input.value = '';
        setLoading(true);

        const payload = {
            contents: chatHistory,
            // Pre komplexn√© odpovede a fakty v≈ædy pou≈æijeme Google Search Grounding
            tools: [{ "google_search": {} }],
            // Syst√©mov√© in≈°trukcie pre "pokroƒçil√Ω" model
            systemInstruction: systemInstruction,
            // Nastavenia modelu
            config: {
                temperature: 0.7, // Mierna kreativita pre analytick√© odpovede
            }
        };

        const maxRetries = 3;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Ak je chyba, sk√∫si≈• znova (ak to nie je posledn√Ω pokus)
                    if (attempt < maxRetries) {
                        await delay(attempt);
                        continue;
                    }
                    throw new Error(`HTTP chyba: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const aiText = candidate.content.parts[0].text;
                    
                    // Extrakcia zdrojov
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // Pridanie odpovede do hist√≥rie a zobrazenie
                    chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                    displayMessage(aiText, 'ai', sources);
                    
                    // √öspe≈°n√© volanie, koniec cyklu
                    break; 

                } else {
                    displayMessage("AI neposkytla ≈æiadnu odpoveƒè. Sk√∫ste preformulova≈• ot√°zku.", 'ai');
                }
            } catch (error) {
                console.error("Chyba poƒças volania API:", error);
                
                if (attempt === maxRetries) {
                    // Ak zlyh√° posledn√Ω pokus
                    const errorMessage = `Nastala kritick√° chyba pri komunik√°cii s AI po ${maxRetries} pokusoch. (${error.message})`;
                    displayMessage(errorMessage, 'ai');
                } else {
                    // ƒåak√°me a sk√∫sime znova
                    console.log(`Opakovan√Ω pokus ƒç. ${attempt + 1}...`);
                }
            }
        }

        setLoading(false);
    }
    
    // --- External Library for Markdown Rendering ---
    // Kni≈ænica je naƒç√≠tan√° staticky v <head> sekcii.


    // --- Event Listener ---
    form.addEventListener('submit', sendMessage);

    // Spustenie 3D anim√°cie po naƒç√≠tan√≠ okna a inicializ√°cia stavu limitu
    window.onload = function () {
        init3D();
        animate3D();
        updateLimitStatusDisplay(); // Zobraz√≠ aktu√°lny stav limitu hneƒè po naƒç√≠tan√≠
    }

</script>
</body>
</html>
