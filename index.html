<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatSlovak AI | Pro Model</title>
    <!-- Na캜칤tanie Tailwind CSS pre jednoduch칳 a modern칳 styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Nastavenie p칤sma Inter a z치kladn칠ho sklenen칠ho pozadia */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #a6c0fe 0%, #f68084 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        /* Glassmorphism efekt pre kontajner */
        .glass-container {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        /* 맚칳l spr치vy od AI pre lep코칤 kontrast na skle */
        .ai-message {
            background: rgba(255, 255, 255, 0.8);
            color: #1f2937;
            border-radius: 0.75rem;
            padding: 0.75rem;
        }

        /* 맚칳l spr치vy od pou쮂셨ate쬬 */
        .user-message {
            background: rgba(144, 202, 249, 0.7);
            color: #1f2937;
            border-radius: 0.75rem;
            padding: 0.75rem;
        }

        /* 맚칳l tla캜idla a vstupu */
        .glass-input, .glass-button {
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.2s;
        }

        .glass-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .glass-input:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }

        .glass-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        // Kon코tanta pre API Key. Vlo svoj k쮂줷 tu.
        const apiKey = "AIzaSyAzWkdCBiqlrFZODs2zEichlIWe68Wo2eI"; // !!! NAHRAD칈콗 T칗MTO VLASTN칗 K컇칔캛 !!!
        
        // --- PECIFIKOVAN칗 MODEL ---
        const MODEL_NAME = "gemini-2.5-flash-preview-05-20";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;

        // --- KONTANTY PRE LIMITY ---
        const MAX_MESSAGES = 30;
        const MAX_LUA_REQUESTS = 16;
        const RESET_DURATION = 3600000; // 1 hodina v milisekund치ch
        const LS_KEY = 'aiChatLimitsV5Pro';
        const LUA_KEYWORDS = ['lua', 'roblox', 'npc', 'mapa', 'k칩d', 'vygeneruj'];
        // -----------------------------

        // Robustn칠 syst칠mov칠 in코trukcie pre pokro캜il칠 schopnosti AI
        const SYSTEM_PROMPT_SK = `
            You are an advanced, highly capable, and creative AI assistant with real-time access to information via Google Search. Your primary task is to provide detailed, creative, and technically accurate responses, always in **Slovak (Sloven캜ina)**. You are capable of:
            1. Analyzing and synthesizing information obtained from the web (Google/YouTube).
            2. Generating **complete and functional Roblox Lua code** for:
               a. Advanced 3D character models (NPCs).
               b. Structured maps (terrain, buildings, game mechanics).
               Always provide Lua code that can be inserted directly into the Roblox Studio Command Bar or a script (e.g. using a single code block).
            3. Providing regular, insightful chat responses.
            Your responses should reflect the capabilities of a 'Pro' model (${MODEL_NAME}).
        `;

        let chatHistory = [];
        let isGenerating = false;
        let currentLimits = {
            messageCount: 0,
            luaRequestCount: 0,
            resetTimestamp: 0 // Timestamp, kedy d칪jde k resetu
        };

        /**
         * Inicializuje aplik치ciu po na캜칤tan칤 okna.
         */
        window.onload = () => {
            document.getElementById('send-button').addEventListener('click', sendMessage);
            document.getElementById('user-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            initializeLimits();
            checkAndUpdateUI();
            // Nastav칤me interval, ktor칳 kontroluje a aktualizuje UI ka쬯칰 sekundu
            setInterval(checkAndUpdateUI, 1000); 
            displayWelcomeMessage();
        };

        /**
         * Na캜칤ta alebo inicializuje limity z localStorage a automaticky resetuje, ak vypr코al 캜as.
         */
        function initializeLimits() {
            const storedLimits = localStorage.getItem(LS_KEY);
            const now = Date.now();

            if (storedLimits) {
                currentLimits = JSON.parse(storedLimits);
                
                // Ak vypr코al resetTimestamp, resetujeme
                if (currentLimits.resetTimestamp <= now) {
                    resetLimits();
                }
            } else {
                // Prv칠 spustenie, inicializujeme
                resetLimits();
            }
        }

        /**
         * Resetuje limity a nastav칤 nov칳 resetTimestamp.
         */
        function resetLimits() {
            currentLimits.messageCount = 0;
            currentLimits.luaRequestCount = 0;
            currentLimits.resetTimestamp = Date.now() + RESET_DURATION;
            saveLimits();
        }

        /**
         * Ulo쮂 aktu치lne limity do localStorage.
         */
        function saveLimits() {
            localStorage.setItem(LS_KEY, JSON.stringify(currentLimits));
        }

        /**
         * Kontroluje limity a aktualizuje UI (tla캜idlo, 캜asova캜).
         */
        function checkAndUpdateUI() {
            const now = Date.now();
            const timeRemaining = currentLimits.resetTimestamp - now;
            const inputElement = document.getElementById('user-input');
            const buttonElement = document.getElementById('send-button');
            const limitDisplay = document.getElementById('limit-display');

            // Automatick칳 reset, ak 캜as vypr코al
            if (timeRemaining <= 0) {
                resetLimits();
            }

            // Kontrola limitov na z치klade POU콯IT칗CH po캜tov
            const totalLimitReached = currentLimits.messageCount >= MAX_MESSAGES;
            const luaLimitReached = currentLimits.luaRequestCount >= MAX_LUA_REQUESTS;
            
            const isBlocked = totalLimitReached; // Prim치rne blokujeme len pri limite spr치v

            // --- ZOBRAZENIE LIMITOV (ZOBRAZUJEME ZOST츼VAJ칔CE) ---
            const messagesRemaining = MAX_MESSAGES - currentLimits.messageCount;
            const luaRemaining = MAX_LUA_REQUESTS - currentLimits.luaRequestCount;
            
            const messagesStatus = `${messagesRemaining}/${MAX_MESSAGES} spr치v`; 
            const luaStatus = `${luaRemaining}/${MAX_LUA_REQUESTS} 3D/Lua`; 

            if (isBlocked) {
                const totalSeconds = Math.ceil(timeRemaining / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const timeString = `${minutes}m ${seconds}s`;

                limitDisplay.className = 'text-center text-sm font-semibold p-2 rounded-xl text-red-100 bg-red-600/70';
                limitDisplay.innerHTML = `
                    <span class="block">游띔 LIMIT VY캛ERPAN칗!</span>
                    <span>Reset o: ${timeString}</span>
                `;
            } else {
                limitDisplay.className = 'text-center text-sm font-medium p-2 rounded-xl text-white/90 bg-black/20';
                
                let luaWarning = '';
                if (luaLimitReached) {
                    luaWarning = ' | <span class="text-yellow-300 font-bold">Limit Lua k칩du vy캜erpan칳!</span>';
                }

                limitDisplay.innerHTML = `
                    <span class="block">Limity (Reset: ${formatTime(timeRemaining)}):</span> 
                    <span class="block">${messagesStatus} | ${luaStatus} ${luaWarning}</span>
                `;
            }

            // --- AKTUALIZ츼CIA UI PRVKOV ---
            inputElement.disabled = isBlocked || isGenerating;
            buttonElement.disabled = isBlocked || isGenerating;
            inputElement.placeholder = isBlocked ? 
                'Limit vy캜erpan칳. Po캜kajte na reset.' : 
                (luaLimitReached ? 'M칪쬰te chatova콘, ale u nem칪쬰te generova콘 3D/Lua k칩dy.' : 'Nap칤코 svoju ot치zku...');
        }
        
        /**
         * Form치tuje milisekundy na min칰ty a sekundy (M:SS).
         * @param {number} ms Milisekundy
         * @returns {string} Form치tovan칳 캜as
         */
        function formatTime(ms) {
            const totalSeconds = Math.ceil(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            const paddedSeconds = seconds.toString().padStart(2, '0');
            return `${minutes}:${paddedSeconds}`;
        }

        /**
         * Zobraz칤 칰vodn칰 spr치vu od AI.
         */
        function displayWelcomeMessage() {
            const welcomeText = `Ahoj! Som **ChatSlovak AI V5 Pro**. Dok치쬰m s tebou vies콘 be쬹칰 komunik치ciu, odpoveda콘 na ot치zky v캞aka Google Search/YouTube a generova콘 pokro캜il칠 Roblox Lua k칩dy pre NPC a mapy. Za캜nime!`;
            appendMessage('ai', welcomeText);
        }

        /**
         * Zobraz칤 textov칰 spr치vu v chatovacom okne.
         */
        function appendMessage(role, text, sources = []) {
            const messagesContainer = document.getElementById('messages-container');
            const messageElement = document.createElement('div');
            messageElement.className = `flex mb-4 ${role === 'user' ? 'justify-end' : 'justify-start'}`;

            const contentElement = document.createElement('div');
            // Pou쮂셨ame markdown pre form치tovanie, tak쬰 je potrebn칠 vlo쬴콘 text ako HTML
            const markdown = new marked.Renderer();
            markdown.code = (code, language) => {
                const langClass = language ? `language-${language}` : '';
                return `<pre class="bg-gray-800 text-white p-3 rounded-lg overflow-x-auto my-2 text-sm"><code>${code}</code></pre>`;
            };

            contentElement.innerHTML = marked.parse(text, { renderer: markdown, breaks: true });
            contentElement.className = `${role === 'user' ? 'user-message' : 'ai-message'} max-w-3xl`;

            // Pridanie cit치ci칤 (zdrojov)
            if (sources.length > 0) {
                const sourcesHtml = sources.map((source, index) => {
                    return `<a href="${source.uri}" target="_blank" class="text-xs text-blue-600 hover:underline block mt-1">${index + 1}. ${source.title}</a>`;
                }).join('');

                const sourcesElement = document.createElement('div');
                sourcesElement.className = 'mt-2 pt-2 border-t border-gray-300 text-gray-700 text-sm';
                sourcesElement.innerHTML = `<strong>Zdroje (Google Search):</strong> ${sourcesHtml}`;
                contentElement.appendChild(sourcesElement);
            }


            messageElement.appendChild(contentElement);
            messagesContainer.appendChild(messageElement);

            // Scroll na spodok
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Zobraz칤 indik치tor na캜칤tania.
         */
        function showLoading() {
            const messagesContainer = document.getElementById('messages-container');
            const loadingElement = document.createElement('div');
            loadingElement.id = 'loading-indicator';
            loadingElement.className = 'flex justify-start mb-4';
            loadingElement.innerHTML = `
                <div class="ai-message flex items-center space-x-2">
                    <div class="loader"></div>
                    <span>AI generuje odpove캞...</span>
                </div>
            `;
            messagesContainer.appendChild(loadingElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Odstr치ni indik치tor na캜칤tania.
         */
        function hideLoading() {
            const loadingElement = document.getElementById('loading-indicator');
            if (loadingElement) {
                loadingElement.remove();
            }
        }

        /**
         * Funkcia na kontrolu, 캜i po쬴adavka vy쬬duje generovanie Lua k칩du.
         * @param {string} query Pou쮂셨ate쬽k칳 dopyt
         * @returns {boolean} True, ak je to po쬴adavka na Lua k칩d.
         */
        function isLuaRequest(query) {
            const lowerQuery = query.toLowerCase();
            return LUA_KEYWORDS.some(keyword => lowerQuery.includes(keyword));
        }


        /**
         * Odoslanie spr치vy do AI.
         */
        async function sendMessage() {
            if (isGenerating) return;

            // 1. Kontrola limitov PRED odoslan칤m
            initializeLimits(); // Aktualizujeme limity
            
            const totalLimitReached = currentLimits.messageCount >= MAX_MESSAGES;
            if (totalLimitReached) {
                // UI sa u zablokovalo cez checkAndUpdateUI, len sa vr치time
                return;
            }

            const input = document.getElementById('user-input');
            const userQuery = input.value.trim();

            if (userQuery === '') return;

            const isLuaReq = isLuaRequest(userQuery);
            const luaLimitReached = currentLimits.luaRequestCount >= MAX_LUA_REQUESTS;

            if (isLuaReq && luaLimitReached) {
                appendMessage('ai', "Prep치캜, limit pre generovanie 3D modelov/Roblox Lua k칩dov bol pre t칰to hodinu vy캜erpan칳. M칪쬰코 mi polo쬴콘 be쬹칰 ot치zku (bez generovania k칩du).");
                input.value = '';
                return;
            }

            // 2. Zobraz칤me spr치vu pou쮂셨ate쬬
            appendMessage('user', userQuery);
            input.value = '';

            // Prid치me dotaz do hist칩rie chatu
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });

            // 3. Zobraz칤me loading indik치tor
            isGenerating = true;
            checkAndUpdateUI(); // Zablokuje input po캜as generovania
            showLoading();

            try {
                // 4. Priprav칤me payload
                const payload = {
                    contents: chatHistory,
                    // Prid치me n치stroj pre vyh쬬d치vanie na Google (vr치tane d치t z YouTube)
                    tools: [{ "google_search": {} }],
                    // Systemov칠 in코trukcie pre pokro캜il칠 schopnosti
                    systemInstruction: {
                        parts: [{ text: SYSTEM_PROMPT_SK }]
                    },
                };

                // 5. Implement치cia Fetch s Exponenci치lnym Backoffom
                let response;
                const maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; // 칔spe코n칠 volanie, vysko캜칤me zo slu캜ky
                        } else if (response.status === 429 && i < maxRetries - 1) {
                            // Pr칤li코 ve쬬 po쬴adaviek, po캜k치me a sk칰sime znova
                            await new Promise(resolve => setTimeout(resolve, delay));
                            delay *= 2; // Exponenci치lny backoff
                        } else {
                            // In칠 chyby alebo vy캜erpan칠 pokusy
                            throw new Error(`API chyba: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        if (i === maxRetries - 1) throw error; // Re-throw po poslednom pokuse
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }

                if (!response || !response.ok) {
                    throw new Error("Nepodarilo sa z칤ska콘 odpove캞 od AI po viacer칳ch pokusoch.");
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];
                let text = "Nastala chyba pri spracovan칤 odpovede od AI. Sk칰ste to pros칤m znova.";
                let sources = [];
                let success = false;

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    text = candidate.content.parts[0].text;
                    success = true;
                    
                    // Z칤skanie zdrojov
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                }

                // 6. Zobraz칤me odpove캞 AI
                appendMessage('ai', text, sources);

                // 7. Aktualizujeme hist칩riu chatu s odpove캞ou AI (aj v pr칤pade chyby, aby nebola preru코en치 konverz치cia)
                chatHistory.push({ role: "model", parts: [{ text: text }] });
                
                // 8. Zv칳코ime po캜칤tadl치 len v pr칤pade, 쬰 odpove캞 bola 칰spe코n치 (success = true)
                if (success) {
                    currentLimits.messageCount++;
                    if (isLuaReq) {
                        currentLimits.luaRequestCount++;
                    }
                    saveLimits();
                }


            } catch (error) {
                console.error("Chyba volania Gemini API:", error);
                appendMessage('ai', `Prep치캜, nastala kritick치 chyba pri komunik치cii s AI: ${error.message}`);
            } finally {
                // 9. Odstr치nime loading indik치tor a aktualizujeme UI
                isGenerating = false;
                hideLoading();
                checkAndUpdateUI();
            }
        }
    </script>
    <!-- Na캜칤tanie Marked.js pre spracovanie Markdownu vo v칳stupoch AI, 캜o je d칪le쬴t칠 pre form치tovanie a Lua k칩d -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

    <!-- Hlavn칳 kontajner s glassmorphism efektom -->
    <div class="glass-container w-full max-w-4xl h-[90vh] flex flex-col p-6 rounded-3xl">

        <!-- Hlavi캜ka -->
        <header class="mb-4 pb-2 border-b border-white/50">
            <h1 class="text-3xl font-extrabold text-white text-shadow-md">ChatSlovak AI: Pro Model</h1>
            <p class="text-white/80 text-sm">Pr칤stup k Google Search a generovanie Roblox Lua k칩du s hodinov칳mi limitmi.</p>
        </header>

        <!-- Kontajner pre spr치vy (Scrollable) -->
        <main id="messages-container" class="flex-grow overflow-y-auto pr-2 mb-4 space-y-4">
            <!-- Spr치vy bud칰 pridan칠 sem cez JavaScript -->
        </main>

        <!-- Vstupn치 oblas콘 -->
        <div class="flex flex-col space-y-2">
            
            <!-- Zobrazenie Limitov a 캜asu resetu -->
            <div id="limit-display" class="w-full">
                <!-- Tu sa zobrazia aktu치lne limity -->
            </div>

            <!-- Vstup a tla캜idlo -->
            <div class="flex space-x-3">
                <input type="text" id="user-input" class="glass-input flex-grow p-3 rounded-xl focus:ring-2 focus:ring-blue-400 focus:outline-none placeholder-gray-700 text-gray-900" placeholder="Nap칤코 svoju ot치zku (napr. 'Vygeneruj Lua k칩d pre NPC obchodn칤ka v Roblox')">
                <button id="send-button" class="glass-button px-6 py-3 rounded-xl font-semibold text-gray-800 bg-white/50 hover:bg-white/70 flex items-center justify-center" aria-label="Odosla콘 spr치vu">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 19-3-9-9-3Z"/><path d="M22 2 11 13"/></svg>
                </button>
            </div>
        </div>

    </div>

</body>
</html>
















