<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatSlovak AI Pokroƒçil√Ω V5 PRO (s Roblox Lua 3D)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f003e; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            position: relative; 
            overflow: hidden;
        }
        #bg-canvas {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1; 
            display: block;
        }
        #chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            
            /* SKLENEN√ù EFEKT */
            background-color: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(15px); 
            -webkit-backdrop-filter: blur(15px); 
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); 
            overflow: hidden;
            z-index: 10; 
        }
        
        .chat-header {
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-footer {
            background-color: rgba(255, 255, 255, 0.05); 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .user-message {
            background-color: #3b82f6; 
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-message {
            background-color: rgba(255, 255, 255, 0.85); 
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            white-space: pre-wrap;
        }
        .source-link {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        #loading-indicator {
            padding: 0.5rem;
            text-align: center;
            color: #9ca3af;
        }
        .ai-message p, .ai-message ul, .ai-message ol, .ai-message strong {
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        
        /* P√¥vodn√Ω ≈°t√Ωl pre k√≥dov√© bloky v spr√°vach - ponech√°vame pre be≈æn√Ω textov√Ω chat */
        .ai-message pre {
            background-color: #1f2937;
            color: #d1d5db;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-top: 0.75rem;
        }

        /* --- NOV√â ≈†T√ùLY PRE LUA K√ìD (PODƒΩA VZORU) --- */
        .lua-code-wrapper {
            background-color: #1f2937; /* Tmav√© pozadie k√≥du */
            border-radius: 0.5rem;
            margin-top: 0.75rem;
            overflow: hidden;
            position: relative;
            border: 1px solid #374151; /* Jemn√Ω okraj */
        }

        .lua-code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #374151; /* Hlaviƒçka k√≥du */
            color: #9ca3af; /* Siv√Ω text */
            font-size: 0.875rem;
        }

        .lua-code-content {
            padding: 1rem;
            color: #d1d5db; /* Svetl√Ω text k√≥du */
            white-space: pre; 
            overflow-x: auto;
            font-family: monospace;
            line-height: 1.4;
            font-size: 0.9rem;
            margin: 0; /* Odstr√°ni okraje <pre> elementu */
        }

        .copy-button {
            background-color: #4f46e5; /* Fialovo-modr√© tlaƒçidlo */
            color: white;
            padding: 0.3rem 0.75rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.15s;
            font-weight: 500;
        }
        .copy-button:hover {
            background-color: #6366f1;
        }
        /* --- KONIEC NOV√ùCH ≈†T√ùLOV --- */

        /* Respons√≠vny layout tlaƒçidiel */
        .button-group {
            display: flex;
            gap: 0.75rem;
        }
        @media (max-width: 640px) {
            .button-group {
                flex-direction: column; 
            }
            .button-group button {
                width: 100%;
            }
        }
    </style>
</head>
<body>

<!-- 3D Canvas pre dynamick√© pozadie -->
<canvas id="bg-canvas"></canvas>

<div id="chat-container">
    <!-- Chat Header -->
    <header class="chat-header p-4 text-white text-center rounded-t-xl shadow-lg">
        <h1 class="text-xl font-bold">üí¨ ChatSlovak AI Pokroƒçil√Ω V5 PRO (Roblox Lua 3D)</h1>
        <p class="text-sm text-gray-400">**Nov√° funkcia:** Zadajte popis pre generovanie komplexn√©ho Lua k√≥du 3D modelu (Roblox Command Bar).</p>
        <!-- INDIK√ÅTOR STAVU LIMITU -->
        <span id="limit-status" class="text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-indigo-700/50">
            Naƒç√≠tavam limit...
        </span>
    </header>

    <!-- Messages Area -->
    <div id="messages">
        <!-- √övodn√° spr√°va s upraven√Ωm form√°tovan√≠m -->
        <div class="message-bubble ai-message">
            <p>Vitaj! Model bol aktualizovan√Ω pre **Generovanie 3D modelov v Lua**. Zadajte presn√Ω popis modelu (napr. *detailn√Ω st√≠haƒçka v retro ≈°t√Ωle*, alebo *modr√° ≈°pir√°lov√° ve≈æa so zlat√Ωmi prvkami*), a kliknite na **Generova≈• 3D Model**.</p>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden">
        <div class="animate-pulse"></div>
    </div>

    <!-- Input Form s dvoma tlaƒçidlami -->
    <form id="chat-form" class="p-4 chat-footer">
        <div class="flex space-x-3">
            <input type="text" id="user-input" placeholder="Zadajte popis modelu (napr. Vesm√≠rna loƒè s 3 tryskami) alebo ot√°zku..." required class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            
            <div class="button-group">
                <!-- Tlaƒçidlo pre generovanie 3D modelu -->
                <button type="button" id="send-3d-model-button" class="bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition duration-150 flex items-center justify-center disabled:bg-purple-400 min-w-max">
                    Generova≈• 3D Model
                </button>
                
                <!-- Tlaƒçidlo pre chat -->
                <button type="submit" id="send-chat-button" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center disabled:bg-blue-400 min-w-max">
                    Odosla≈•
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Kni≈ænice pre pokroƒçil√∫ funkƒçnos≈• a 3D grafiku -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.10/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
    // --- 3D Background Initialization (Three.js) ---
    let scene, camera, renderer, discoBall;
    let discoLights = [];
    const lightColors = [0xff00ff, 0x00ffff, 0xffff00]; 
    const canvas = document.getElementById('bg-canvas');
    let mouseX = 0, mouseY = 0;

    function init3D() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111); 

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 3000); 
        camera.position.z = 200;

        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true }); 
        renderer.setSize(window.innerWidth, window.innerHeight);

        const ambientLight = new THREE.AmbientLight(0x404040, 0.5); 
        scene.add(ambientLight);

        const ballGeometry = new THREE.SphereGeometry(40, 64, 32);
        const ballMaterial = new THREE.MeshPhongMaterial({
            color: 0xcccccc,
            specular: 0xffffff, 
            shininess: 100, 
            reflectivity: 0.9,
        });
        discoBall = new THREE.Mesh(ballGeometry, ballMaterial);
        scene.add(discoBall);

        const lightIntensity = 2;
        const lightDistance = 200;
        
        // Vytvorenie a umiestnenie dynamick√Ωch svetiel (PointLights)
        const lightOrbitRadius = 150;
        lightColors.forEach((colorHex, index) => {
            const pointLight = new THREE.PointLight(colorHex, lightIntensity, lightDistance);
            // Poƒçiatoƒçn√© umiestnenie v kruhu
            pointLight.position.x = lightOrbitRadius * Math.cos(index * Math.PI * 2 / 3);
            pointLight.position.y = lightOrbitRadius * Math.sin(index * Math.PI * 2 / 3);
            pointLight.position.z = 0;
            scene.add(pointLight);
            discoLights.push(pointLight);
        });
        
        document.addEventListener('mousemove', onDocumentMouseMove, false);
        window.addEventListener('resize', onWindowResize, false);
    }

    function onDocumentMouseMove(event) {
        // Nastavuje poz√≠ciu my≈°i normalizovan√∫ k stredu obrazovky
        mouseX = (event.clientX - window.innerWidth / 2) * 0.2;
        mouseY = (event.clientY - window.innerHeight / 2) * 0.2;
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate3D() {
        requestAnimationFrame(animate3D);

        const time = Date.now() * 0.0002;
        
        // Rot√°cia diskoguƒæe
        discoBall.rotation.y += 0.005; 
        discoBall.rotation.x += 0.002;

        const orbitRadius = 150;
        // Anim√°cia svetiel
        discoLights.forEach((light, index) => {
            const angle = time * (index + 1) * 0.5;
            light.position.x = orbitRadius * Math.cos(angle + index * 1.5);
            light.position.z = orbitRadius * Math.sin(angle + index * 1.5);
            light.position.y = 50 * Math.sin(time + index); // Pohyb hore/dole
        });

        // Pohyb kamery podƒæa my≈°i pre jemn√Ω paralax efekt
        camera.position.x += (mouseX - camera.position.x) * 0.05;
        camera.position.y += (-mouseY - camera.position.y) * 0.05;
        camera.lookAt(scene.position);
        
        renderer.render(scene, camera);
    }

    // --- Rate Limiting Configuration ---
    const MAX_MESSAGES_PER_HOUR = 30; 
    const RATE_LIMIT_WINDOW_MS = 60 * 60 * 1000; 
    const STORAGE_KEY = 'chatSlovakMessageTimestamps';
    
    // Glob√°lna premenn√° pre ƒçasovaƒç resetu
    window.rateLimitTimeout = null; 

    /** * Aktualizuje UI element s inform√°ciou o zost√°vaj√∫com limite a vracia objekt so stavom.
     * @returns {object} { remaining: number, timeUntilReset: number }
     */
    function updateLimitStatusDisplay(currentTimestamps) {
        const now = Date.now();
        // Odfiltruje len tie timestampy, ktor√© s√∫ e≈°te v r√°mci hodinov√©ho okna.
        const recentTimestamps = currentTimestamps.filter(timestamp => (now - timestamp) < RATE_LIMIT_WINDOW_MS);
        const messagesSent = recentTimestamps.length;
        const messagesRemaining = MAX_MESSAGES_PER_HOUR - messagesSent;

        const limitStatusElement = document.getElementById('limit-status');
        
        let timeUntilResetMs = 0;

        if (messagesRemaining <= 0) {
            // Limit VYƒåERPAN√ù. Vypoƒç√≠tame ƒças, kedy vypr≈°√≠ najstar≈°ia spr√°va.
            if (recentTimestamps.length > 0) {
                // Najprv zorad√≠me, aby sme na≈°li najstar≈°iu spr√°vu
                const oldestTimestamp = recentTimestamps.sort((a, b) => a - b)[0];
                timeUntilResetMs = RATE_LIMIT_WINDOW_MS - (now - oldestTimestamp);
                if (timeUntilResetMs < 0) timeUntilResetMs = 0; // Ak ƒças u≈æ uplynul, nastav√≠me na 0.
            }
            
            const minutes = Math.floor(timeUntilResetMs / 60000);
            const seconds = Math.floor((timeUntilResetMs % 60000) / 1000);
            
            // UI Update
            limitStatusElement.textContent = `Limit VYƒåERPAN√ù. Reset za ${minutes}m ${seconds}s`;
            limitStatusElement.className = "text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-red-700/70";
            
            return { remaining: 0, timeUntilReset: timeUntilResetMs };

        } else {
            // Limit OK
            limitStatusElement.textContent = `Zost√°va: ${messagesRemaining} z ${MAX_MESSAGES_PER_HOUR} spr√°v/h`;
            limitStatusElement.className = "text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-green-600/70";
            
            return { remaining: messagesRemaining, timeUntilReset: 0 };
        }
    }

    /**
     * Kontroluje a aplikuje limit poƒçtu spr√°v pomocou localStorage.
     * Taktie≈æ nastavuje automatick√Ω ƒçasovaƒç resetu, ak je limit prekroƒçen√Ω.
     * @param {boolean} apply - Ak je true, aplikuje sa nov√Ω timestamp (odosiela sa spr√°va).
     * @returns {boolean} True, ak je povolen√© odosla≈• spr√°vu.
     */
    function checkAndApplyRateLimit(apply = false) { 
        const now = Date.now();
        let timestamps = [];
        
        // 1. Naƒç√≠ta≈• a vyƒçisti≈• star√© ƒçasy
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                timestamps = JSON.parse(stored);
                if (!Array.isArray(timestamps)) {
                    timestamps = [];
                }
            }
        } catch (e) {
            console.error("Chyba pri ƒç√≠tan√≠ localStorage:", e);
            timestamps = [];
        }

        let recentTimestamps = timestamps.filter(timestamp => (now - timestamp) < RATE_LIMIT_WINDOW_MS);
        
        // 2. Skontrolova≈• limit
        const { remaining: messagesRemaining, timeUntilReset } = updateLimitStatusDisplay(recentTimestamps);

        // 3. Logika aplik√°cie a monitorovania
        if (messagesRemaining > 0) {
            // Limit OK. Zru≈°√≠me existuj√∫ci ƒçasovaƒç (ak nejak√Ω be≈æal z predch√°dzaj√∫ceho zlyhania)
            if (window.rateLimitTimeout) {
                clearTimeout(window.rateLimitTimeout);
                window.rateLimitTimeout = null;
            }

            if (apply) {
                // Ak sa m√° aplikova≈• (odosiela sa spr√°va), prid√°me nov√Ω timestamp
                recentTimestamps.push(now);
                
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(recentTimestamps));
                } catch (e) {
                    console.error("Chyba pri z√°pise do localStorage:", e);
                }
                // Prekresl√≠me UI po pridan√≠ novej spr√°vy
                updateLimitStatusDisplay(recentTimestamps); 
            }
            
            return true; 
        } else {
            // Limit VYƒåERPAN√ù. Nastav√≠me ƒçasovaƒç na kontrolu, ak e≈°te nie je spusten√Ω.
            if (timeUntilReset > 0) {
                if (window.rateLimitTimeout) {
                    clearTimeout(window.rateLimitTimeout); // V≈ædy vyƒçist√≠me star√Ω, aby sme predi≈°li duplik√°tom
                }
                
                // Nastav√≠me timeout o 1 sekundu dlh≈°√≠ ako je ƒças do resetu pre zaruƒçenie uplynutia.
                window.rateLimitTimeout = setTimeout(() => {
                    window.rateLimitTimeout = null; 
                    checkAndApplyRateLimit(false); // Skontrolujeme znova bez aplik√°cie timestampu
                }, timeUntilReset + 1000); 
            }
            
            return false;
        }
    }

    // --- Text-to-Speech (TTS) Functionality ---
    const synth = window.speechSynthesis;
    let voices = [];

    function populateVoiceList() {
        voices = synth.getVoices();
    }

    if (synth.onvoiceschanged !== undefined) {
        synth.onvoiceschanged = populateVoiceList;
    } else {
        populateVoiceList(); 
    }
    
    function speakText(text) {
        if (!synth || !text) return;
        
        if (synth.speaking) {
            synth.cancel();
        }

        const cleanText = text.replace(/\*\*/g, '').replace(/###\s*/g, ''); 
        const utterance = new SpeechSynthesisUtterance(cleanText);

        let selectedVoice = voices.find(voice => voice.lang.startsWith('sk-SK'));
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => voice.name.includes('Google') && voice.lang.startsWith('en'));
        }
        if (!selectedVoice) {
            selectedVoice = voices[0];
        }

        if (selectedVoice) {
            utterance.voice = selectedVoice;
            utterance.lang = selectedVoice.lang;
        } else {
            utterance.lang = 'sk-SK'; 
        }

        utterance.rate = 1.0; 
        utterance.pitch = 1.0; 

        synth.speak(utterance);
    }


    // --- API Configuration and Global Variables ---

    const apiKey = "AIzaSyAzWkdCBiqlrFZODs2zEichlIWe68Wo2eI"; 
    const apiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/";
    
    // Konfigur√°cia pre text a 3D modely (Gemini 2.5 Pro)
    const textModelName = 'gemini-2.5-pro'; 
    const textApiUrl = `${apiUrlBase}${textModelName}:generateContent?key=${apiKey}`;

    // V≈°eobecn√° syst√©mov√° in≈°trukcia pre chat
    const systemInstructionChat = {
        parts: [{ 
            // UPDATOVAN√Å IN≈†TRUKCIA: Odstr√°nenie po≈æiadavky na nadpisy (##) a zv√Ωraznenie tuƒçn√©ho textu a zoznamov ako prim√°rneho n√°stroja pre ≈°trukt√∫ru.
            text: "Si ≈°piƒçkov√Ω analytik, strat√©g a vedeck√Ω konzultant. Tvojou √∫lohou je spracov√°va≈• mimoriadne zlo≈æit√©, multi-disciplin√°rne ot√°zky. Tvoje odpovede musia by≈• hƒ∫bkov√©, syntetick√© a MUSIA BY≈§ V≈ΩDY logicky a vizu√°lne ≈°trukt√∫rovan√©. Pou≈æ√≠vaj Markdown pre: **1. Odr√°≈æky/Zoznamy pre prehƒæadn√© body.** **2. Tuƒçn√Ω text (**slovo**) pre kƒæ√∫ƒçov√© pojmy a oddeƒæovanie sekci√≠.** D√îLE≈ΩIT√â: NIKDY nepou≈æ√≠vaj symbol `#` (nadpisy). 3. V≈ædy pou≈æi Google Search na overenie a poskytnutie aktu√°lnych, faktick√Ωch inform√°ci√≠ pre komplexn√© t√©my. Odpovedaj v√Ωhradne v slovenƒçine a buƒè u≈æitoƒçn√Ω."
        }]
    };
    
    // Syst√©mov√° in≈°trukcia pre generovanie 3D Lua k√≥du
    const systemInstruction3DModel = {
        parts: [{
            text: `You are an expert Roblox Lua script writer. Your task is to generate clean, self-contained Lua code for the Roblox Studio Command Bar to construct an advanced 3D model based on the user's description. The code MUST:
1.  Be runnable instantly in the Command Bar.
2.  Use basic Roblox Parts, CFrame, and Materials.
3.  Be contained in a single code block.
4.  Start with 'local model = Instance.new("Model", game.Workspace)' and ensure all created parts are parented to this model for easy deletion.
5.  Use comments sparingly, only for complex logic.
6.  The final output MUST ONLY contain the Lua code (no introductory text, explanations, or markdown fences outside the code block).`
        }]
    };


    let chatHistory = [];
    const messagesDiv = document.getElementById('messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('user-input');
    const sendChatButton = document.getElementById('send-chat-button');
    const send3DModelButton = document.getElementById('send-3d-model-button'); 
    const loadingIndicator = document.getElementById('loading-indicator');


    // --- Utility Functions ---

    function delay(attempt) {
        const baseDelay = 1000;
        const maxDelay = 16000;
        const currentDelay = Math.min(maxDelay, baseDelay * Math.pow(2, attempt - 1));
        return new Promise(resolve => setTimeout(resolve, currentDelay));
    }

    /**
     * NOV√Å FUNKCIA: Skop√≠ruje text do schr√°nky a zmen√≠ text tlaƒçidla.
     */
    function copyToClipboard(button, textToCopy) {
        // Pou≈æitie document.execCommand('copy') pre kompatibilitu v iFrame
        const textarea = document.createElement('textarea');
        textarea.value = textToCopy;
        textarea.style.position = 'fixed'; 
        textarea.style.opacity = 0;
        document.body.appendChild(textarea);
        textarea.select();
        
        try {
            const success = document.execCommand('copy');
            if (success) {
                const originalText = button.textContent;
                button.textContent = 'Skop√≠rovan√©!';
                button.style.backgroundColor = '#10b981'; // Green color for success
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.backgroundColor = '#4f46e5'; // Restore color
                }, 2000);
            } else {
                console.error('Kop√≠rovanie zlyhalo.');
            }
        } catch (err) {
            console.error('Kop√≠rovanie ne√∫spe≈°n√©', err);
        }
        document.body.removeChild(textarea);
    }
    
    // Spr√≠stupn√≠ funkciu glob√°lne, aby ju bolo mo≈æn√© vola≈• z dynamicky vygenerovan√©ho HTML
    window.copyToClipboard = copyToClipboard; 


    // --- UI Functions ---

    function displayMessage(text, sender, sources = []) {
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${sender === 'user' ? 'user-message' : 'ai-message'}`;
        
        let formattedText = '';
        const luaCodeMatch = text.match(/```lua\s*([\s\S]*?)```/); // Regex pre n√°jdenie Lua k√≥du

        if (sender === 'ai' && luaCodeMatch) {
            // --- VLASTN√â RENDEROVANIE LUA K√ìDU S OBLAKOM A TLAƒåIDLOM ---
            
            const fullCodeBlock = luaCodeMatch[0];
            const pureLuaCode = luaCodeMatch[1].trim();
            
            // 1. Z√≠skanie in≈°trukƒçn√©ho textu (text mimo k√≥dov√©ho bloku)
            const instructionText = text.replace(fullCodeBlock, '').trim();
            
            // 2. Form√°tovanie in≈°trukci√≠ ako markdown
            let instructionsHtml = '';
            if (typeof marked !== 'undefined') {
                instructionsHtml = marked.parse(instructionText);
            } else {
                instructionsHtml = `<p>${instructionText.replace(/\n/g, '<br>')}</p>`;
            }
            
            // Opatrn√© escapovanie sp√§tn√Ωch lomiek a dol√°rov pre pou≈æitie v `onclick` atrib√∫te
            const escapedCode = pureLuaCode.replace(/`/g, '\\`').replace(/$/g, '&#36;');

            // 3. Vytvorenie HTML pre vlastn√Ω Lua obal
            const luaWrapperHtml = `
                <div class="lua-code-wrapper">
                    <div class="lua-code-header">
                        <span>Lua Code (Roblox Command Bar)</span>
                        <button class="copy-button" onclick="copyToClipboard(this, \`${escapedCode}\`)">
                            Kop√≠rova≈• k√≥d
                        </button>
                    </div>
                    <pre class="lua-code-content">${pureLuaCode}</pre>
                </div>
            `;
            
            formattedText = instructionsHtml + luaWrapperHtml;

        } else if (typeof marked !== 'undefined') {
            // --- ≈†tandardn√© Markdown pre be≈æn√Ω chat ---
            formattedText = marked.parse(text); 
        } else {
            formattedText = `<p>${text.replace(/\n/g, '<br>')}</p>`; 
        }
        
        bubble.innerHTML = formattedText;

        if (sender === 'ai' && sources.length > 0) {
            const sourcesList = document.createElement('div');
            sourcesList.className = "mt-2 pt-2 border-t border-gray-300 text-xs";
            sourcesList.innerHTML = `<strong class="text-gray-600">Zdroje:</strong>`;
            
            sources.slice(0, 3).forEach((source, index) => {
                if (source.uri && source.title) {
                    const link = document.createElement('a');
                    link.href = source.uri;
                    link.target = "_blank";
                    link.className = "source-link hover:text-blue-600";
                    link.textContent = `${index + 1}. ${source.title}`;
                    sourcesList.appendChild(link);
                }
            });
            bubble.appendChild(sourcesList);
        }

        messagesDiv.appendChild(bubble);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    function setLoading(isLoading, isModel = false) {
        sendChatButton.disabled = isLoading;
        send3DModelButton.disabled = isLoading; 
        input.disabled = isLoading;
        loadingIndicator.classList.toggle('hidden', !isLoading);
        
        loadingIndicator.querySelector('div').textContent = isLoading 
            ? (isModel ? 'Vytv√°ram 3D model, ƒçakajte...' : 'Rozm√Ω≈°ƒæam...') 
            : '';
    }

    // --- Core API Logic (generovanie 3D modelu) ---

    /** Generuje k√≥d pre Roblox Command Bar na vytvorenie 3D modelu. */
    async function generate3DModelCode(userPrompt) {
        
        if (!checkAndApplyRateLimit(true)) { // Aplikujeme timestamp
             return; 
        }

        displayMessage(`Po≈æiadavka na 3D model: "${userPrompt}"`, 'user');
        input.value = '';
        setLoading(true, true); 

        const payload = {
            contents: [{ role: "user", parts: [{ text: userPrompt }] }],
            systemInstruction: systemInstruction3DModel, 
            generationConfig: {
                temperature: 0.5, 
            }
        };

        const maxRetries = 3;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(textApiUrl, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorMessage = `HTTP chyba so statusom: ${response.status}.`;
                    try {
                        const errorBody = await response.json();
                        if (errorBody && errorBody.error && errorBody.error.message) {
                            errorMessage = `Chyba API: ${errorBody.error.message}`;
                        }
                    } catch(e) { /* ignore json parse error */ }

                    if (attempt < maxRetries) {
                        console.warn(`Pokus ${attempt} zlyhal, opakujem za chv√≠ƒæu: ${errorMessage}`);
                        await delay(attempt);
                        continue;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                const aiCode = result.candidates?.[0]?.content?.parts?.[0]?.text || "Model neposkytol ≈æiadny k√≥d.";
                
                // Form√°tovanie odpovede S IN≈†TRUKCIAMI a k√≥dov√Ωm blokom (ten bude vizu√°lne spracovan√Ω vo funkcii displayMessage)
                const responseText = `**Vygenerovan√Ω Roblox Lua K√≥d:**
Tento k√≥d je pripraven√Ω na skop√≠rovanie a vlo≈æenie priamo do **Command Bar** v Roblox Studio.

\`\`\`lua
${aiCode}
\`\`\`

**In≈°trukcie:**
1. Otvorte Roblox Studio a v√°≈° projekt.
2. Ak nevid√≠te konzolu, otvorte **View** a zapnite **Command Bar** alebo stlaƒçte \`F9\` a prejdite na Command Bar.
3. Skop√≠rujte cel√Ω k√≥d vy≈°≈°ie (alebo pou≈æite tlaƒçidlo Kop√≠rova≈•).
4. Vlo≈æte k√≥d do **Command Bar** a stlaƒçte \`Enter\`. V√°≈° model sa objav√≠ v pracovnom priestore (\`game.Workspace\`).`;
                
                displayMessage(responseText, 'ai');
                speakText("K√≥d pre 3D model bol vygenerovan√Ω a vlo≈æen√Ω do chatu.");
                break;
                
            } catch (error) {
                console.error("Chyba poƒças volania 3D Model API:", error);
                if (attempt === maxRetries) {
                    displayMessage(`KRITICK√Å CHYBA po ${maxRetries} pokusoch: ${error.message}`, 'ai');
                }
            }
        }
        setLoading(false);
    }
    
    /** Spracuje odoslanie textovej chatovej ot√°zky. */
    async function sendChatQuery(userQuery) {
        
        if (!checkAndApplyRateLimit(true)) { // Aplikujeme timestamp
            return; 
        }

        displayMessage(userQuery, 'user');
        input.value = '';

        chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
        setLoading(true, false); 

        const payload = {
            contents: chatHistory,
            tools: [{ "google_search": {} }],
            systemInstruction: systemInstructionChat,
            generationConfig: {
                temperature: 0.7, 
            }
        };

        const maxRetries = 3;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(textApiUrl, { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorMessage = `HTTP chyba so statusom: ${response.status}.`;
                    try {
                        const errorBody = await response.json();
                        if (errorBody && errorBody.error && errorBody.error.message) {
                            errorMessage = `Chyba API: ${errorBody.error.message}`;
                        }
                    } catch (e) {
                        errorMessage = `HTTP chyba so statusom ${response.status}.`;
                    }

                    if (attempt < maxRetries) {
                        console.warn(`Pokus ${attempt} zlyhal, opakujem za chv√≠ƒæu: ${errorMessage}`);
                        await delay(attempt);
                        continue;
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const aiText = candidate.content.parts[0].text;
                    
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                    displayMessage(aiText, 'ai', sources);
                    speakText(aiText); // Volanie TTS
                    
                    break; 

                } else {
                    displayMessage("AI neposkytla ≈æiadnu odpoveƒè. (Pr√°zdna odpoveƒè od modelu)", 'ai');
                }
            } catch (error) {
                console.error("Chyba poƒças volania API:", error);
                
                if (attempt === maxRetries) {
                    const errorMessage = `Nastala kritick√° chyba pri komunik√°cii s AI po ${maxRetries} pokusoch. (${error.message})`;
                    displayMessage(errorMessage, 'ai');
                }
            }
        }

        setLoading(false);
    }
    
    // --- Spustenie aplik√°cie a event listenery ---

    window.onload = function () {
        init3D();
        animate3D();
        
        // Pri ≈°tarte len skontrolujeme limit bez aplik√°cie (apply=false)
        checkAndApplyRateLimit(false); 
        
        // Listener pre tlaƒçidlo CHAT (Odosla≈•)
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const userQuery = input.value.trim();
            if (!userQuery) return;
            
            if (!apiKey) {
                displayMessage("CHYBA: API kƒæ√∫ƒç nie je nastaven√Ω. (Nedostatoƒçn√° autoriz√°cia)", 'ai');
                return;
            }
            sendChatQuery(userQuery);
        });

        // Listener pre tlaƒçidlo 3D MODEL (Generova≈• 3D Model)
        send3DModelButton.addEventListener('click', async () => {
            const userPrompt = input.value.trim();
            
            if (!userPrompt) {
                displayMessage("Pros√≠m, zadajte podrobn√Ω popis 3D modelu, ktor√Ω m√° AI vygenerova≈• v Lua k√≥de.", 'ai');
                return;
            }

            if (!apiKey) {
                displayMessage("CHYBA: API kƒæ√∫ƒç nie je nastaven√Ω. (Nedostatoƒçn√° autoriz√°cia)", 'ai');
                return;
            }
            
            await generate3DModelCode(userPrompt);
        });


        // Preƒç√≠tanie √∫vodnej spr√°vy po naƒç√≠tan√≠ hlasov
        const initialMessageText = "Vitaj! Model bol aktualizovan√Ω pre Generovanie 3D modelov v Lua. Zadajte presn√Ω popis modelu a kliknite na Generova≈• 3D Model.";
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = () => {
                populateVoiceList();
                if (messagesDiv.children.length === 1) { 
                     speakText(initialMessageText);
                }
            };
        } else {
            setTimeout(() => {
                if (messagesDiv.children.length === 1) { 
                     speakText(initialMessageText);
                }
            }, 500);
        }
    }

</script>
</body>
</html>












