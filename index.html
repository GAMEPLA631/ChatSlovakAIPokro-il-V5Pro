<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatSlovak AI Pokroƒçil√Ω V5 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Kni≈ænice pre pokroƒçil√∫ funkƒçnos≈• a 3D grafiku boli presunut√© na koniec <body> pre zaruƒçenie naƒç√≠tania -->

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Tmav√© pozadie pre lep≈°√≠ disco efekt */
            background-color: #1f003e; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            position: relative; 
            overflow: hidden;
        }
        /* ≈†t√Ωly pre 3D Canvas pozadie */
        #bg-canvas {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1; 
            display: block;
        }
        #chat-container {
            width: 100%;
            max-width: 800px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            
            /* SKLENEN√ù EFEKT */
            background-color: rgba(255, 255, 255, 0.1); /* Priesvitn√© pozadie */
            backdrop-filter: blur(15px); /* Kƒæ√∫ƒçov√Ω efekt rozostrenia */
            -webkit-backdrop-filter: blur(15px); /* Pre Safari */
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2); /* Jemn√Ω biely okraj */
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Hlb≈°√≠, priehƒæadn√Ω tie≈à */
            overflow: hidden;
            z-index: 10; 
        }
        
        .chat-header {
            /* Sklenen√° hlaviƒçka, tmav√© p√≠smo */
            background-color: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-footer {
            /* Sklenen√° p√§tiƒçka */
            background-color: rgba(255, 255, 255, 0.05); 
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .user-message {
            background-color: #3b82f6; /* Blue-500 */
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 0.25rem;
        }
        .ai-message {
            /* AI bublina zost√°va takmer biela pre ƒçitateƒænos≈•, s miernou transparentnos≈•ou */
            background-color: rgba(255, 255, 255, 0.85); 
            color: #1f2937;
            margin-right: auto;
            border-bottom-left-radius: 0.25rem;
            white-space: pre-wrap; /* Preserve formatting from markdown response */
        }
        .source-link {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
        }
        #loading-indicator {
            padding: 0.5rem;
            text-align: center;
            color: #9ca3af;
        }
        /* Style for markdown-like formatting */
        .ai-message p, .ai-message ul, .ai-message ol, .ai-message strong {
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
    </style>
</head>
<body>

<!-- 3D Canvas pre dynamick√© pozadie -->
<canvas id="bg-canvas"></canvas>

<div id="chat-container">
    <!-- Chat Header -->
    <header class="chat-header p-4 text-white text-center rounded-t-xl shadow-lg">
        <h1 class="text-xl font-bold">üí¨ ChatSlovak AI Pokroƒçil√Ω V5 Pro</h1>
        <p class="text-sm text-gray-400">Na≈°a spoloƒçnos≈• GAMEPLA631: P√Ωtajte sa na veƒæmi zlo≈æit√© t√©my. Pou≈æ√≠va overen√© d√°ta (Grounding).</p>
        <!-- NOV√ù INDIK√ÅTOR STAVU LIMITU -->
        <span id="limit-status" class="text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-indigo-700/50">
            Naƒç√≠tavam limit...
        </span>
    </header>

    <!-- Messages Area -->
    <div id="messages">
        <div class="message-bubble ai-message">
            <p>Vitaj v **ChatSlovak AI Pokroƒçil√Ω V5 Pro!** Som tvoj ≈°pecializovan√Ω **Model V5**. Som tu, aby som ti ako hlavn√Ω analytik spoloƒçnosti GAMEPLA631 pomohol s hƒ∫bkov√Ωm spracovan√≠m d√°t, rie≈°en√≠m zlo≈æit√Ωch strategick√Ωch v√Ωziev a komplexnou anal√Ωzou. Pripraven√Ω na pr√°cu!</p>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden">
        <!-- Zmenen√° textov√° spr√°va pri naƒç√≠tavan√≠ podƒæa po≈æiadavky pou≈æ√≠vateƒæa -->
        <div class="animate-pulse">Rozm√Ω≈°ƒæam Pre lep≈°iu odpoveƒè ƒçakaj 90s</div>
    </div>

    <!-- Input Form -->
    <form id="chat-form" class="p-4 border-t border-gray-200 chat-footer">
        <div class="flex space-x-3">
            <input type="text" id="user-input" placeholder="Zadajte svoju zlo≈æit√© po≈æiadavku..." required class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            <button type="submit" id="send-button" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition duration-150 flex items-center justify-center disabled:bg-blue-400">
                Odosla≈•
            </button>
        </div>
    </form>
</div>

<!-- Kni≈ænice pre pokroƒçil√∫ funkƒçnos≈• a 3D grafiku -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.10/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<script>
    // --- 3D Background Initialization (Three.js) ---
    let scene, camera, renderer, discoBall;
    let discoLights = [];
    const lightColors = [0xff00ff, 0x00ffff, 0xffff00]; // Farby pre disco l√∫ƒçe: Magenta, Cyan, Yellow
    const canvas = document.getElementById('bg-canvas');
    let mouseX = 0, mouseY = 0;

    function init3D() {
        // Sc√©na
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111); // Veƒæmi tmav√© pozadie

        // Kamera
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 3000); 
        camera.position.z = 200;

        // Renderer
        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true }); 
        renderer.setSize(window.innerWidth, window.innerHeight);

        // Ambient Light
        // Mierne ambientn√© svetlo, aby boli viditeƒæn√© tmav√© strany gule
        const ambientLight = new THREE.AmbientLight(0x404040, 0.5); 
        scene.add(ambientLight);

        // 1. Disco Guƒæa (Sphere)
        const ballGeometry = new THREE.SphereGeometry(40, 64, 32);
        // MeshPhongMaterial pre leskl√Ω, reflexn√Ω vzhƒæad
        const ballMaterial = new THREE.MeshPhongMaterial({
            color: 0xcccccc,
            specular: 0xffffff, // Biela spektr√°lna farba
            shininess: 100, // Vysok√Ω lesk
            reflectivity: 0.9,
        });
        discoBall = new THREE.Mesh(ballGeometry, ballMaterial);
        scene.add(discoBall);

        // 2. Disco Svetl√° (Point Lights orbiting the ball)
        const lightIntensity = 2;
        const lightDistance = 200;
        const lightOrbitRadius = 150;

        lightColors.forEach((colorHex, index) => {
            // PointLight simuluje siln√Ω bodov√Ω l√∫ƒç, ktor√Ω dopad√° na guƒæu
            const pointLight = new THREE.PointLight(colorHex, lightIntensity, lightDistance);
            pointLight.position.x = lightOrbitRadius * Math.cos(index * Math.PI * 2 / 3);
            pointLight.position.y = lightOrbitRadius * Math.sin(index * Math.PI * 2 / 3);
            pointLight.position.z = 0;
            scene.add(pointLight);
            discoLights.push(pointLight);
        });
        
        // Event listener pre sledovanie my≈°i (pre interaktivitu)
        document.addEventListener('mousemove', onDocumentMouseMove, false);
        window.addEventListener('resize', onWindowResize, false);
    }

    function onDocumentMouseMove(event) {
        // Upravuje poz√≠ciu kamery (virtu√°lny pohyb)
        mouseX = (event.clientX - window.innerWidth / 2) * 0.2;
        mouseY = (event.clientY - window.innerHeight / 2) * 0.2;
    }

    function onWindowResize() {
        // Zabezpeƒçuje responz√≠vnos≈• 3D pl√°tna
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate3D() {
        requestAnimationFrame(animate3D);

        const time = Date.now() * 0.0002;
        
        // 1. Rot√°cia Disco Guƒæa
        discoBall.rotation.y += 0.005; 
        discoBall.rotation.x += 0.002;

        // 2. Pohyb svetiel (orbit√°lny pohyb okolo stredu)
        const orbitRadius = 150;
        discoLights.forEach((light, index) => {
            const angle = time * (index + 1) * 0.5;
            // Orbit√°lny pohyb XZ
            light.position.x = orbitRadius * Math.cos(angle + index * 1.5);
            light.position.z = orbitRadius * Math.sin(angle + index * 1.5);
            // Vertik√°lny pohyb Y
            light.position.y = 50 * Math.sin(time + index); 
        });

        // Pomaly pos√∫vame kameru v reakcii na my≈°
        camera.position.x += (mouseX - camera.position.x) * 0.05;
        camera.position.y += (-mouseY - camera.position.y) * 0.05;
        camera.lookAt(scene.position);
        
        renderer.render(scene, camera);
    }

    // --- Rate Limiting Configuration (ZNOVU PRIDAN√â) ---
    const MAX_MESSAGES_PER_HOUR = 30; // Maxim√°lne 30 spr√°v za hodinu
    const RATE_LIMIT_WINDOW_MS = 60 * 60 * 1000; // 1 hodina v milisekund√°ch
    const STORAGE_KEY = 'chatSlovakMessageTimestamps';

    /** * Aktualizuje UI element s inform√°ciou o zost√°vaj√∫com limite a vracia zost√°vaj√∫ce spr√°vy.
     * @param {Array<number>} currentTimestamps Aktu√°lny zoznam ƒçasov√Ωch peƒçiatok spr√°v v okne.
     * @returns {number} Zost√°vaj√∫ci poƒçet spr√°v.
     */
    function updateLimitStatusDisplay(currentTimestamps) {
        const now = Date.now();
        
        // 1. Filtrujeme, aby sme odstr√°nili star√© spr√°vy mimo okna
        const recentTimestamps = currentTimestamps.filter(timestamp => (now - timestamp) < RATE_LIMIT_WINDOW_MS);
        
        const messagesSent = recentTimestamps.length;
        const messagesRemaining = MAX_MESSAGES_PER_HOUR - messagesSent;

        const limitStatusElement = document.getElementById('limit-status');
        
        if (messagesRemaining <= 0) {
            // Limit prekroƒçen√Ω
            // Ak je array pr√°zdny, vr√°time max delay, inak vypoƒç√≠tame ƒças do resetu
            const timeUntilResetMs = recentTimestamps.length > 0 
                ? RATE_LIMIT_WINDOW_MS - (now - recentTimestamps[0])
                : 0; // Pre istotu, hoci by sa toto nemalo sta≈•

            
            // Prevod milisek√∫nd na min√∫ty a sekundy
            const minutes = Math.floor(timeUntilResetMs / 60000);
            const seconds = Math.floor((timeUntilResetMs % 60000) / 1000);
            
            limitStatusElement.textContent = `Limit VYƒåERPAN√ù. Reset za ${minutes}m ${seconds}s`;
            limitStatusElement.className = "text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-red-700/70";
            return 0; // 0 zost√°vaj√∫cich spr√°v
        } else {
            // V r√°mci limitu
            limitStatusElement.textContent = `Zost√°va: ${messagesRemaining} z ${MAX_MESSAGES_PER_HOUR} spr√°v/h`;
            limitStatusElement.className = "text-xs font-medium mt-1 inline-block py-1 px-3 rounded-full bg-green-600/70";
            return messagesRemaining;
        }
    }


    /**
     * Kontroluje a aplikuje limit poƒçtu spr√°v.
     * @returns {boolean} True, ak je povolen√© odosla≈• spr√°vu.
     */
    function checkAndApplyRateLimit() {
        const now = Date.now();
        let timestamps = [];
        
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                // Sk√∫sime parsova≈•. Ak zlyh√°, zaƒçneme s pr√°zdnym poƒæom.
                timestamps = JSON.parse(stored);
                if (!Array.isArray(timestamps)) {
                    timestamps = [];
                }
            }
        } catch (e) {
            console.error("Chyba pri ƒç√≠tan√≠ localStorage:", e);
            timestamps = [];
        }

        // 1. Filtrujeme star√© spr√°vy mimo okna
        let recentTimestamps = timestamps.filter(timestamp => (now - timestamp) < RATE_LIMIT_WINDOW_MS);

        // 2. Aktualizujeme UI a z√≠skame zost√°vaj√∫ci poƒçet spr√°v
        const messagesRemaining = updateLimitStatusDisplay(recentTimestamps);

        if (messagesRemaining > 0) {
            // 3. Ak je povolen√©, prid√°me nov√∫ spr√°vu a ulo≈æ√≠me
            recentTimestamps.push(now);
            
            try {
                // Ulo≈æ√≠me zoznam platn√Ωch ƒçasov√Ωch peƒçiatok vr√°tane novej
                localStorage.setItem(STORAGE_KEY, JSON.stringify(recentTimestamps));
            } catch (e) {
                console.error("Chyba pri z√°pise do localStorage:", e);
            }
            
            // Znova aktualizujeme UI, aby sme zohƒæadnili nov√∫ spr√°vu
            updateLimitStatusDisplay(recentTimestamps); 
            return true; 
        } else {
            // Limit bol prekroƒçen√Ω, UI bola aktualizovan√° v updateLimitStatusDisplay
            return false;
        }
    }

    // --- API Configuration and Global Variables ---

    // D√îLE≈ΩIT√â: Vlo≈æte svoj Gemini API kƒæ√∫ƒç sem.
    const apiKey = "AIzaSyAzWkdCBiqlrFZODs2zEichlIWe68Wo2eI"; // Nechajte pr√°zdne, ak ho poskytuje prostredie Canvas.
    const apiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/";
    
    // Zmena modelu na ≈°tandardn√Ω (flash) pre rie≈°enie chyby 403 (pr√≠stupov√© pr√°va/autoriz√°cia).
    const modelName = 'gemini-2.5-flash-preview-05-20';
    const apiUrl = `${apiUrlBase}${modelName}:generateContent?key=${apiKey}`;

    // Syst√©mov√© in≈°trukcie pre pokroƒçil√∫ AI (definuj√∫ jej osobnos≈• a ≈°t√Ωl)
    const systemInstruction = {
        parts: [{ 
            text: "Si ≈°piƒçkov√Ω analytik, strat√©g a vedeck√Ω konzultant. Tvojou √∫lohou je spracov√°va≈• mimoriadne zlo≈æit√©, multi-disciplin√°rne ot√°zky. Tvoje odpovede musia by≈• hƒ∫bkov√©, syntetick√©, logicky ≈°trukt√∫rovan√© (napr. s pou≈æit√≠m oƒç√≠slovan√Ωch bodov, odsekov alebo zoznamov) a musia preukazova≈• pokroƒçil√© kritick√© myslenie. V≈ædy pou≈æi Google Search na overenie a poskytnutie aktu√°lnych, faktick√Ωch inform√°ci√≠ pre komplexn√© t√©my, ak si to ot√°zka vy≈æaduje. Odpovedaj v√Ωhradne v slovenƒçine." 
        }]
    };

    let chatHistory = [];
    const messagesDiv = document.getElementById('messages');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const loadingIndicator = document.getElementById('loading-indicator');

    // --- UI Functions ---

    /** Vytvor√≠ a prid√° bublinu spr√°vy do chatu */
    function displayMessage(text, sender, sources = []) {
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${sender === 'user' ? 'user-message' : 'ai-message'}`;
        
        // Konvertujeme Markdown na HTML pre lep≈°iu ƒçitateƒænos≈• AI odpoved√≠
        let formattedText;
        // Zabezpeƒçenie: Pou≈æijeme marked.parse() len ak je objekt 'marked' definovan√Ω.
        if (typeof marked !== 'undefined') {
            formattedText = marked.parse(text); 
        } else {
            // Z√°lo≈æn√Ω mechanizmus: Ak marked zlyh√°, pou≈æijeme len z√°kladn√Ω text s prevodom riadkov.
            formattedText = `<p>${text.replace(/\n/g, '<br>')}</p>`; 
            console.warn("Markdown kni≈ænica 'marked' nebola naƒç√≠tan√°, pou≈æ√≠va sa z√°lo≈æn√Ω textov√Ω form√°t.");
        }
        
        bubble.innerHTML = formattedText;

        // Pridanie zdrojov (grounding) pre AI odpovede
        if (sender === 'ai' && sources.length > 0) {
            const sourcesList = document.createElement('div');
            sourcesList.className = "mt-2 pt-2 border-t border-gray-300 text-xs";
            sourcesList.innerHTML = `<strong class="text-gray-600">Zdroje:</strong>`;
            
            // Limitujeme na 3 zdroje pre prehƒæadnos≈•
            sources.slice(0, 3).forEach((source, index) => {
                if (source.uri && source.title) {
                    const link = document.createElement('a');
                    link.href = source.uri;
                    link.target = "_blank";
                    link.className = "source-link hover:text-blue-600";
                    link.textContent = `${index + 1}. ${source.title}`;
                    sourcesList.appendChild(link);
                }
            });
            bubble.appendChild(sourcesList);
        }

        messagesDiv.appendChild(bubble);
        messagesDiv.scrollTop = messagesDiv.scrollHeight; // Scroll to bottom
    }

    /** Nastav√≠ stav naƒç√≠tania */
    function setLoading(isLoading) {
        sendButton.disabled = isLoading;
        input.disabled = isLoading;
        loadingIndicator.classList.toggle('hidden', !isLoading);
    }

    // --- Core API Logic ---

    /**
     * Implementuje exponenci√°lne oneskorenie a opakovan√© pokusy pre API volania.
     * @param {number} attempt Aktu√°lny pokus (od 1).
     * @returns {Promise<number>} oneskorenie v milisekund√°ch.
     */
    function delay(attempt) {
        const baseDelay = 1000; // 1 sekunda
        const maxDelay = 16000; // Max 16 sek√∫nd
        const currentDelay = Math.min(maxDelay, baseDelay * Math.pow(2, attempt - 1));
        return new Promise(resolve => setTimeout(resolve, currentDelay));
    }

    /** Spracuje odoslanie formul√°ra a zavol√° Gemini API. */
    async function sendMessage(event) {
        event.preventDefault();
        const userQuery = input.value.trim();
        if (!userQuery) return;

        // KONTROLA LIMITU: Teraj≈°√≠ k√≥d kontroluje a aplikuje limit
        if (!checkAndApplyRateLimit()) {
            input.value = ''; 
            return;
        }

        displayMessage(userQuery, 'user');
        chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
        input.value = '';
        setLoading(true);

        const payload = {
            contents: chatHistory,
            // Pre komplexn√© odpovede a fakty v≈ædy pou≈æijeme Google Search Grounding
            tools: [{ "google_search": {} }],
            // Syst√©mov√© in≈°trukcie pre "pokroƒçil√Ω" model
            systemInstruction: systemInstruction,
            // Nastavenia modelu
            config: {
                temperature: 0.7, // Mierna kreativita pre analytick√© odpovede
            }
        };

        const maxRetries = 3;
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    // Ak je chyba, sk√∫si≈• znova (ak to nie je posledn√Ω pokus)
                    if (attempt < maxRetries) {
                        await delay(attempt);
                        continue;
                    }
                    // Pridanie logovania pre lep≈°iu diagnostiku
                    console.error("API Error Response Status:", response.status, "Text:", await response.text());
                    throw new Error(`HTTP chyba: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const aiText = candidate.content.parts[0].text;
                    
                    // Extrakcia zdrojov
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // Pridanie odpovede do hist√≥rie a zobrazenie
                    chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                    displayMessage(aiText, 'ai', sources);
                    
                    // √öspe≈°n√© volanie, koniec cyklu
                    break; 

                } else {
                    displayMessage("AI neposkytla ≈æiadnu odpoveƒè. Sk√∫ste preformulova≈• ot√°zku.", 'ai');
                }
            } catch (error) {
                console.error("Chyba poƒças volania API:", error);
                
                if (attempt === maxRetries) {
                    // Ak zlyh√° posledn√Ω pokus
                    const errorMessage = `Nastala kritick√° chyba pri komunik√°cii s AI po ${maxRetries} pokusoch. (${error.message})`;
                    displayMessage(errorMessage, 'ai');
                } else {
                    // ƒåak√°me a sk√∫sime znova
                    console.log(`Opakovan√Ω pokus ƒç. ${attempt + 1}...`);
                }
            }
        }

        setLoading(false);
    }
    
    // --- External Library for Markdown Rendering ---
    // Kni≈ænica je naƒç√≠tan√° staticky na konci <body>.


    // --- Event Listener bol presunut√Ω do window.onload ---

    // Spustenie 3D anim√°cie po naƒç√≠tan√≠ okna a inicializ√°cia stavu limitu
    window.onload = function () {
        init3D();
        animate3D();
        // Inicializ√°cia zobrazenia limitu pri naƒç√≠tan√≠
        checkAndApplyRateLimit(); 

        // D√îLE≈ΩIT√â: Listener na odoslanie formul√°ra prid√°vame a≈æ po naƒç√≠tan√≠ v≈°etk√Ωch skriptov!
        form.addEventListener('submit', sendMessage);
    }

</script>
</body>
</html>


